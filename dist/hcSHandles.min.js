var shandles;(()=>{"use strict";var t={d:(e,o)=>{for(var i in o)t.o(o,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:o[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{RotateHandleGroup:()=>P,SHandleManager:()=>p,ScaleHandleGroup:()=>O,TranslateHandleGroup:()=>T});class o{constructor(){this.nodeids=[],this.matrices=[]}gather(t,e=null){for(let o=0;o<e.length;o++)this.nodeids.push(e[o]),this.matrices.push(t.model.getNodeMatrix(e[o]))}clone(t){let e=new o;return e.gather(t,this.nodeids),e}do(t){for(let e=0;e<this.nodeids.length;e++)t.model.setNodeMatrix(this.nodeids[e],this.matrices[e])}}class i{constructor(t){this._viewer=t,this.undoStack=[],this.undoTop=0,this.undoPointer=0,this._undoTypes=[]}setUndoPoint(t){this.undoStack[this.undoPointer]=t,this.undoPointer++,this.undoTop=this.undoPointer}undo(){if(this.undoPointer>0){if(this.undoPointer==this.undoTop){let t=this.undoStack[this.undoPointer-1][0].clone(this._viewer);this.setUndoPoint([t]),this.undoPointer--,this.undoTop=this.undoPointer}this.undoPointer--;for(let t=0;t<this.undoStack[this.undoPointer].length;t++)this.undoStack[this.undoPointer][t].do(this._viewer)}}redo(){if(this.undoPointer<this.undoTop){this.undoPointer++;for(let t=0;t<this.undoStack[this.undoPointer].length;t++)this.undoStack[this.undoPointer][t].do(this._viewer)}}}class r extends Communicator.Operator.OperatorBase{constructor(t,e){super(t),this._viewer=t,this._manager=e,this._startmatrix=null,this._selectedHandleGroup=null,this._isClick=!1,this.oldNodeId=null,this.isHandled=!1}setHandled(t){return this.isHandled}async onMouseDown(t){this.isHandled=!1,super.onMouseDown(t),this._selectedHandleGroup=null,this._isClick=!0;let e=new Communicator.PickConfig(Communicator.SelectionMask.Line);e.restrictToOverlays=!0;const o=await this._viewer.view.pickFromPoint(t.getPosition(),e);if(o.getPosition()){let e=this._viewer.model.getNodeParent(o.getNodeId()),i=this._viewer.model.getNodeParent(e),r=this._manager.getHandleGroup(i);r&&(this._selectedHandleGroup=r,this._selectedHandle=r.getHandle(e),this._selectedHandle.handleMouseDown(t,o),this.oldColor=[this._selectedHandle._color.copy()],this._viewer.model.setNodesFaceColor([e],new Communicator.Color(255,255,0)),this.oldNodeId=e,this.isHandled=!0,t.setHandled(!0))}}async onMouseMove(t){if(super.onMouseMove(t),this._isClick=!1,this._selectedHandleGroup)await this._selectedHandle.handleMouseMove(t),this._manager.refreshAll(this._selectedHandleGroup),this.isHandled=!0,t.setHandled(!0);else{this.oldNodeId&&(this._viewer.model.setNodesFaceColor([this.oldNodeId],this.oldColor[0]),this.oldNodeId=null);let e=new Communicator.PickConfig(Communicator.SelectionMask.Face);e.restrictToOverlays=!0;const o=await this._viewer.view.pickFromPoint(t.getPosition(),e);if(o.getPosition()){let t=this._viewer.model.getNodeParent(o.getNodeId()),e=this._viewer.model.getNodeParent(t);this._manager.getHandleGroup(e)&&(this.oldColor=await this._viewer.model.getNodesFaceColor([t]),this.oldNodeId=t,this._viewer.model.setNodesFaceColor([t],new Communicator.Color(255,255,0)))}}}async onMouseUp(t){super.onMouseUp(t),this._selectedHandleGroup&&(this._viewer.model.setNodesFaceColor([this._selectedHandle._nodeid],this.oldColor[0]),this._selectedHandleGroup=null),this.oldNodeId&&(this._viewer.model.setNodesFaceColor([this.oldNodeId],this.oldColor[0]),this.oldNodeId=null),this._isClick&&this._manager.remove()}}function n(t,e,o){let i=[],r=[],n=new Communicator.MeshData,a=null;for(let n=0;n<t.length;n++){let s,h=[];if(s=n<t.length-1?Communicator.Point3.subtract(t[n+1],t[n]).normalize():Communicator.Point3.subtract(t[n],t[n-1]).normalize(),Communicator.Util.generatePointsOnCircle(h,t[n],e,o,s),n>0){let t=h[0],e=1e11,n=0;for(let o=0;o<a.length;o++)Communicator.Point3.distance(t,a[o])<e&&(e=Communicator.Point3.distance(t,a[o]),n=o);let s,m=n;s=m==a.length-1?0:m+1;let l=0;for(let t=0;t<o;t++){let e=l+n,s=l+n+1;e>a.length-1&&(e=e-a.length+1),s>a.length-1&&(s=s-a.length+1),l++,e<0&&(e=a.length-1+e),s<0&&(s=a.length-1+s);let m=t+1;m>o-1&&(m=0),i.push(a[e].x,a[e].y,a[e].z),i.push(h[t].x,h[t].y,h[t].z),i.push(h[m].x,h[m].y,h[m].z),i.push(h[m].x,h[m].y,h[m].z),i.push(a[s].x,a[s].y,a[s].z),i.push(a[e].x,a[e].y,a[e].z);let u=Communicator.Plane.createFromPoints(a[e],h[t],h[m]);for(let t=0;t<6;t++)r.push(u.normal.x,u.normal.y,u.normal.z)}}a=h}return n.addFaces(i,r),n}function a(t,e,o){let i=h(t),r=Communicator.Matrix.multiply(e,Communicator.Matrix.inverse(i)),n=Communicator.Matrix.multiply(r,o);return Communicator.Matrix.multiply(n,i)}function s(t,e){let o=t.transform(new Communicator.Point3(0,0,0)),i=t.transform(e),r=Communicator.Point3.subtract(i,o);return r.normalize(),r}function h(t){let e=new Communicator.Matrix;return e.setTranslationComponent(t.x,t.y,t.z),e}function m(t,e,o){let i=s(t,o);o.set(i.x,i.y,i.z);let r=t.transform(e);e.set(r.x,r.y,r.z)}function l(t,e){let o=t.view.getCamera(),i=o.getPosition(),r=o.getTarget(),n=Communicator.Point3.subtract(r,i).normalize();return Communicator.Plane.createFromPointAndNormal(e,n)}function u(t,e,o,i){return c(Communicator.Point3.subtract(t,i),Communicator.Point3.subtract(e,i),o)}async function d(t){const e=(1+Math.sqrt(5))/2,o=Math.sqrt(10+2*Math.sqrt(5))/(4*e),i=o/2,r=o/(2*e),n=[];n[0]=new Communicator.Point3(-r,i,0),n[1]=new Communicator.Point3(r,i,0),n[2]=new Communicator.Point3(-r,-i,0),n[3]=new Communicator.Point3(r,-i,0),n[4]=new Communicator.Point3(0,-r,i),n[5]=new Communicator.Point3(0,r,i),n[6]=new Communicator.Point3(0,-r,-i),n[7]=new Communicator.Point3(0,r,-i),n[8]=new Communicator.Point3(i,0,-r),n[9]=new Communicator.Point3(i,0,r),n[10]=new Communicator.Point3(-i,0,-r),n[11]=new Communicator.Point3(-i,0,r);for(let t=0;t<n.length;t++)n[t].normalize();let a=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],s=12;for(let t=0;t<3;t++){let t=[];a.map((e=>{const o=n[e[0]],i=n[e[1]],r=n[e[2]];n[s++]=new Communicator.Point3(o.x+i.x,o.y+i.y,o.z+i.z).scale(.5).normalize(),n[s++]=new Communicator.Point3(i.x+r.x,i.y+r.y,i.z+r.z).scale(.5).normalize(),n[s++]=new Communicator.Point3(r.x+o.x,r.y+o.y,r.z+o.z).scale(.5).normalize(),t.push([e[0],s-3,s-1]),t.push([s-3,s-2,s-1]),t.push([s-3,e[1],s-2]),t.push([s-2,e[2],s-1])})),a=t}const h=[],m=[];for(const t of a)for(let e=0;e<3;e++){const o=t[e];h.push(n[o].x),h.push(n[o].y),h.push(n[o].z);const i=n[o].normalize();m.push(i.x),m.push(i.y),m.push(i.z)}const l=new Communicator.MeshData;return l.addFaces(h,m),l.setFaceWinding(Communicator.FaceWinding.CounterClockwise),await t.model.createMesh(l)}function c(t,e,o){return Math.atan2(Communicator.Point3.dot(Communicator.Point3.cross(t,e),o),Communicator.Point3.dot(t,e))*(180/Math.PI)}function g(t,e){let o=Communicator.Point3.dot(t.normal,e)+t.d;return Communicator.Point3.subtract(e,new Communicator.Point3(o*t.normal.x,o*t.normal.y,o*t.normal.z))}function _(t,e,o){e.normalize();var i=Communicator.Point3.subtract(o,t),r=Communicator.Point3.dot(i,e),n=Communicator.Point3.add(t,Communicator.Point3.scale(e,r));return Communicator.Point3.subtract(n,o),n}function w(t,e,o,i){const r=e.copy(),n=e.copy().add(o),a=t.view.unprojectPoint(i,0),s=t.view.unprojectPoint(i,.5);return null!==a&&null!==s?Communicator.Util.lineLineIntersect(r,n,a,s):null}class p{constructor(t){this._viewer=t,this._translateSnapping=0,this._rotateSnapping=0,this._handleScale=1,this._undoManager=new i(t),this._handles=[],this._undoManager=new i(t),this._handlenode=this._viewer.model.createNode(this._viewer.model.getRootNode(),"advancedHandles");var e=this;this._eventReceivers=[],this._viewer.overlayManager.setCamera(p.overlayIndex,this._viewer.view.getCamera()),this._viewer.setCallbacks({camera:function(t,o,i,r){e._viewer.overlayManager.setCamera(p.overlayIndex,e._viewer.view.getCamera());for(let t=0;t<e._handles.length;t++)e._handles[t].cameraUpdate(e._viewer.view.getCamera())}}),this._viewer.overlayManager.setViewport(p.overlayIndex,Communicator.OverlayAnchor.UpperLeftCorner,0,Communicator.OverlayUnit.ProportionOfCanvas,0,Communicator.OverlayUnit.ProportionOfCanvas,1,Communicator.OverlayUnit.ProportionOfCanvas,1,Communicator.OverlayUnit.ProportionOfCanvas),this._viewer.overlayManager.setCamera(p.overlayIndex,this._viewer.view.getCamera());let o=new r(this._viewer,this),n=hwv.operatorManager.registerCustomOperator(o);this._viewer.operatorManager.push(n)}registerEventReceiver(t){this._eventReceivers.push(t)}transmitEvent(t){for(let e=0;e<this._eventReceivers.length;e++)this._eventReceivers[e](t)}async add(t,e,o=null,i=null){this._handles.push(t),await t.show(e,o,i)}async remove(){await this._viewer.model.deleteNode(this._handlenode),this._handlenode=await this._viewer.model.createNode(this._viewer.model.getRootNode(),"advancedHandles"),this._handles=[]}getHandleGroup(t){for(let e=0;e<this._handles.length;e++)if(this._handles[e]._topNode==t||this._handles[e]._topNode2==t)return this._handles[e]}refreshAll(t=null){this._viewer.overlayManager.setCamera(p.overlayIndex,this._viewer.view.getCamera());for(let e=0;e<this._handles.length;e++)this._handles[e]!=t&&(this._handles[e]._targetCenter=this._viewer.model.getNodeNetMatrix(this._handles[e]._targetNodes[0]).transform(this._handles[e]._targetCenterLocal),this._handles[e].updateHandle())}setRelative(t){for(let e=0;e<this._handles.length;e++)this._handles[e].setRelative(t)}async _getArcCenter(t){let e=t.getNodeId(),o=t.getLineEntity();if(null!==e&&null!==o){let t=this._viewer.model,i=await t.getEdgeProperty(e,o.getLineId());if(i instanceof Communicator.SubentityProperties.CircleElement){const o=i.origin;return t.getNodeNetMatrix(e).transform(o,o),{center:o,normal:i.normal}}return null}}async positionFromSelection(t){let e=t.getNodeId(),o=t.getFaceEntity(),i=t.getLineEntity(),r=null,n=null;if(null!==i||null!==o){if(null!=i){let o=await this._getArcCenter(t);if(o){if(o.normal){let t=this._viewer.model.getNodeNetMatrix(e),i=t.transform(new Communicator.Point3(0,0,0)),r=t.transform(o.normal),a=Communicator.Point3.cross(new Communicator.Point3(1,0,0),o.normal);a.length()<1e-5&&(a=Communicator.Point3.cross(new Communicator.Point3(0,1,0),o.normal)),n=Communicator.Point3.subtract(r,i)}r=o.center}else{let t=i.getPoints();n=Communicator.Point3.subtract(t[1],t[0]);let e=n.length();r=t[0].copy().add(n.normalize().scale(e/2))}}else n=o.getNormal(),r=o.getBounding().center().copy();let a=function(t,e){const o=1e-7;t.normalize(),e.normalize();let i=Communicator.Point3.cross(t,e),r=Communicator.Point3.dot(t,e),n=i.length();if(n>-1e-7&&n<o){if(!(r<0))return new Communicator.Matrix;if(t.x<-1e-7||t.x>o)i.x=t.y,i.y=-t.x,i.z=0;else if(t.y<-1e-7||t.y>o)i.x=-t.y,i.y=t.x,i.z=0;else{if(!(t.z<-1e-7||t.z>o))return new Communicator.Matrix;i.x=-t.z,i.z=t.x,i.y=0}}var a=Math.atan2(n,r);return a*=180/Math.PI,Communicator.Matrix.createFromOffAxisRotation(i,a)}(new Communicator.Point3(1,0,0),n),s=this._viewer.model.getNodeNetMatrix(e),h=new Communicator.Point3(s.m[0],s.m[1],s.m[2]).normalize(),m=new Communicator.Point3(s.m[4],s.m[5],s.m[6]).normalize(),l=new Communicator.Point3(s.m[8],s.m[9],s.m[10]).normalize(),u=new Communicator.Matrix;u.m[0]=h.x,u.m[1]=h.y,u.m[2]=h.z,u.m[4]=m.x,u.m[5]=m.y,u.m[6]=m.z,u.m[8]=l.x,u.m[9]=l.y,u.m[10]=l.z;let d=Communicator.Matrix.inverse(u);return a=Communicator.Matrix.multiply(a,d),{position:r,rotation:a}}}setUndoPoint(t){let e=new o;e.gather(this._viewer,t),this._undoManager.setUndoPoint([e])}undo(){this._undoManager.undo(),this.refreshAll()}redo(){this._undoManager.redo(),this.refreshAll()}setTranslateSnapping(t){this._translateSnapping=t}setRotateSnapping(t){this._rotateSnapping=t}setHandleScale(t){this._handleScale=t,this.refreshAll()}}p.overlayIndex=7;class M{constructor(t){this._manager=t,this._viewer=t._viewer,this._handles=[],this._targetNodes=null,this._relative=!0}getManager(){return this._manager}getViewer(){return this._viewer}remove(){this._viewer.model.deleteNode(this._handlenode)}setRelative(t){this._relative=t,this._topNode&&this.updateHandle()}getRelative(){return this._relative}cameraUpdate(t){for(let e=0;e<this._handles.length;e++)this._handles[e].cameraUpdate(t)}getHandle(t){for(let e=0;e<this._handles.length;e++)if(this._handles[e]._nodeid==t)return this._handles[e]}updateHandle(){let t=new Communicator.Matrix;t.setScaleComponent(this._manager._handleScale,this._manager._handleScale,this._manager._handleScale);let e=this._calculateStartMatrix(),o=this._targetCenter,i=new Communicator.Matrix;i.setTranslationComponent(o.x,o.y,o.z),i=Communicator.Matrix.multiply(t,i);let r=Communicator.Matrix.multiply(e,i);this._viewer.model.setNodeMatrix(this._topNode,r),hwv.model.setNodeMatrix(this._topNode2,i);for(let t=0;t<this._handles.length;t++)this._handles[t].update(this._viewer.view.getCamera())}async show(t,e=null,o=null){this._targetNodes=t;let i=new Communicator.Matrix;if(i.setScaleComponent(this._manager._handleScale,this._manager._handleScale,this._manager._handleScale),e)this._targetCenter=e.copy();else{let e=await this._viewer.model.getNodesBounding(t);this._targetCenter=e.center()}this._targetCenterLocal=Communicator.Matrix.inverse(this._viewer.model.getNodeNetMatrix(this._targetNodes[0])).transform(this._targetCenter),this._extraRotation=o,this._topNode=this._viewer.model.createNode(this._manager._handlenode,""),this._topNode2=this._viewer.model.createNode(this._manager._handlenode,"");let r=this._calculateStartMatrix(),n=new Communicator.Matrix;n.setTranslationComponent(this._targetCenter.x,this._targetCenter.y,this._targetCenter.z),n=Communicator.Matrix.multiply(i,n);let a=Communicator.Matrix.multiply(r,n);this._viewer.model.setNodeMatrix(this._topNode,a),this._viewer.model.setNodeMatrix(this._topNode2,n)}_calculateStartMatrix(){let t=new Communicator.Matrix;if(this._relative){let e=this._viewer.model.getNodeNetMatrix(this._targetNodes[0]).copy(),o=new Communicator.Point3(e.m[0],e.m[1],e.m[2]).normalize(),i=new Communicator.Point3(e.m[4],e.m[5],e.m[6]).normalize(),r=new Communicator.Point3(e.m[8],e.m[9],e.m[10]).normalize();t.m[0]=o.x,t.m[1]=o.y,t.m[2]=o.z,t.m[4]=i.x,t.m[5]=i.y,t.m[6]=i.z,t.m[8]=r.x,t.m[9]=r.y,t.m[10]=r.z}return this._extraRotation&&(t=Communicator.Matrix.multiply(this._extraRotation,t)),t}}class C{constructor(t){this._group=t,this._nodeid=null}getType(){return this._type}async show(){let t=this._group.getViewer();this._nodeid&&(t.overlayManager.addNodes(p.overlayIndex,[this._nodeid]),t.model.setInstanceModifier(Communicator.InstanceModifier.SuppressCameraScale,[this._nodeid],!0),t.model.setInstanceModifier(Communicator.InstanceModifier.DoNotLight,[this._nodeid],!0),t.model.setInstanceModifier(Communicator.InstanceModifier.ExcludeBounding,[this._nodeid],!0),t.model.setInstanceModifier(Communicator.InstanceModifier.IgnoreCutting,[this._nodeid],!0))}update(){}cameraUpdate(t){}async handleMouseDown(t,e){let o=this._group.getViewer();this._startmatrix=await o.model.getNodeNetMatrix(this._nodeid),this._startTargetMatrices=[];for(let t=0;t<this._group._targetNodes.length;t++)this._startTargetMatrices.push(o.model.getNodeMatrix(this._group._targetNodes[t]));await this._group.getManager().setUndoPoint(this._group._targetNodes),this._startPosition=e.getPosition(),this._startPosition2D=t.getPosition()}async handleMouseMove(t){await this._group.getManager().transmitEvent(this._group._targetNodes)}}class x extends C{constructor(t,e,o,i){super(t),this._type=0,this._axis=e,this._rotation=o,this._color=i}async generateBaseGeometry(){let t=[];Communicator.Util.generatePointsOnCircle(t,new Communicator.Point3(0,0,0),.15,64,new Communicator.Point3(0,0,1));let e=n(t.splice(0,t.length/2),.0055,10);this._group.getManager()._arcmesh=await this._group.getViewer().model.createMesh(e)}async show(){let t=this._group.getViewer(),e=new Communicator.Matrix;this._axis&&Communicator.Util.computeOffaxisRotation(this._axis,this._rotation,e),this._nodeid=t.model.createNode(this._group._topNode,""),this._group.getManager()._arcmesh||await this.generateBaseGeometry();let o=new Communicator.MeshInstanceData(this._group.getManager()._arcmesh);await t.model.createMeshInstance(o,this._nodeid),this._axis&&t.model.setNodeMatrix(this._nodeid,e),t.model.setNodesFaceColor([this._nodeid],this._color),await super.show(),await this.orientToCamera(t.view.getCamera())}cameraUpdate(t){this.orientToCamera(t)}update(t){this.orientToCamera(t)}async orientToCamera(t){let e=this._group.getViewer(),o=t.getPosition(),i=t.getTarget(),r=Communicator.Point3.subtract(i,o).normalize();o.x=i.x-1e5*r.x,o.y=i.y-1e5*r.y,o.z=i.z-1e5*r.z;let n=e.model.getNodeMatrix(this._nodeid),a=e.model.getNodeNetMatrix(this._nodeid),h=s(a,new Communicator.Point3(0,0,1)),m=Communicator.Point3.subtract(e.view.getCamera().getTarget(),o).normalize();if(h.equalsWithTolerance(m,.01))return;let l=Communicator.Matrix.inverse(a).transform(o),u=g(Communicator.Plane.createFromPointAndNormal(new Communicator.Point3(0,0,0),new Communicator.Point3(0,0,1)),l);u.normalize();let d=c(new Communicator.Point3(-1,0,0),u,new Communicator.Point3(0,0,1));if(isNaN(d))return;let _=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),d,_);let w=Communicator.Matrix.multiply(_,n);await e.model.setNodeMatrix(this._nodeid,w)}async handleMouseMove(t){let e=this._group.getViewer(),o=new Communicator.Point3(0,0,0),i=new Communicator.Point3(0,0,1);m(this._startmatrix,o,i);let r=l(e,this._startPosition),n=e.view.raycastFromPoint(t.getPosition()),h=new Communicator.Point3;r.intersectsRay(n,h);let d=Communicator.Plane.createFromPointAndNormal(o,i),c=Math.abs(Communicator.Util.computeAngleBetweenVector(i,r.normal)),_=new Communicator.Point3;if(c>85&&c<95)_=g(d,h);else{let r=e.view.raycastFromPoint(t.getPosition());Communicator.Plane.createFromPointAndNormal(o,i).intersectsRay(r,_)}let w=u(this._startPosition,_,i,o);this._group.getManager()._rotateSnapping&&(w=Math.round(w/this._group.getManager()._rotateSnapping)*this._group.getManager()._rotateSnapping);for(let t=0;t<this._startTargetMatrices.length;t++){let o=s(Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))),i),r=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(o,w,r);let n=Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(this._group._targetCenter);e.model.setNodeMatrix(this._group._targetNodes[t],a(n,this._startTargetMatrices[t],r))}this._group.updateHandle(),super.handleMouseMove(t)}}var N;!function(t){function e(t,e){var o=Math.abs(t),i=Math.abs(e);return 0===t?Math.log(i):0===e?Math.log(o):3e3>o&&3e3>i?.5*Math.log(t*t+e*e):Math.log(t/Math.cos(Math.atan2(e,t)))}function o(t,e,o,i,r){if(void 0!==r)t.w=e,t.x=o,t.y=i,t.z=r;else{if("object"==typeof e&&void 0===i){if("w"in e||"x"in e||"y"in e||"z"in e)return t.w=e.w||0,t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if("re"in e&&"im"in e)return t.w=e.re,t.x=e.im,t.y=0,void(t.z=0);if(4===e.length)return t.w=e[0],t.x=e[1],t.y=e[2],void(t.z=e[3]);if(3===e.length)return t.w=0,t.x=e[0],t.y=e[1],void(t.z=e[2]);throw Error("Invalid object")}if("string"==typeof e&&void 0===i){var a=1;if(o=0,i={i:"x",j:"y",k:"z"},null===(e=e.match(/\d+\.?\d*e[+-]?\d+|\d+\.?\d*|\.\d+|./g)))throw Error("Parse error");for(r=t.w=t.x=t.y=t.z=0;r<e.length;r++){var s=e[r],h=e[r+1];if(" "!==s&&"\t"!==s&&"\n"!==s)if("+"===s)a++;else if("-"===s)o++;else{if(0===a+o)throw Error("Parse error"+s);if(void 0!==(a=i[s]))" "===h||isNaN(h)?s="1":(s=h,r++);else{if(isNaN(s))throw Error("Parser error");void 0!==(a=i[h])&&r++}t[a||"w"]+=parseFloat((o%2?"-":"")+s),a=o=0}}if(0<a+o)throw Error("Parser error")}else void 0===e&&t!==n?(t.w=1,t.x=t.y=t.z=0):(t.w=e||0,o&&3===o.length?(t.x=o[0],t.y=o[1],t.z=o[2]):(t.x=o||0,t.y=i||0,t.z=r||0))}}function i(t,e,o){var i="";return 0!==t&&(""!==o?i+=0>t?" - ":" + ":0>t&&(i+="-"),1===(t=Math.abs(t))&&""!==e||(i+=t),i+=e),i}function r(t,e,i,n){if(!(this instanceof r))return new r(t,e,i,n);o(this,t,e,i,n)}var n={w:1,x:0,y:0,z:0};r.prototype={w:1,x:0,y:0,z:0,add:function(t,e,i,a){return o(n,t,e,i,a),new r(this.w+n.w,this.x+n.x,this.y+n.y,this.z+n.z)},sub:function(t,e,i,a){return o(n,t,e,i,a),new r(this.w-n.w,this.x-n.x,this.y-n.y,this.z-n.z)},neg:function(){return new r(-this.w,-this.x,-this.y,-this.z)},norm:function(){var t=this.w,e=this.x,o=this.y,i=this.z;return Math.sqrt(t*t+e*e+o*o+i*i)},normSq:function(){var t=this.w,e=this.x,o=this.y,i=this.z;return t*t+e*e+o*o+i*i},normalize:function(){var t=this.w,e=this.x,o=this.y,i=this.z,n=Math.sqrt(t*t+e*e+o*o+i*i);return n<r.EPSILON?r.ZERO:new r(t*(n=1/n),e*n,o*n,i*n)},mul:function(t,e,i,a){o(n,t,e,i,a),t=this.w,e=this.x,i=this.y,a=this.z;var s=n.w,h=n.x,m=n.y,l=n.z;return new r(t*s-e*h-i*m-a*l,t*h+e*s+i*l-a*m,t*m+i*s+a*h-e*l,t*l+a*s+e*m-i*h)},scale:function(t){return new r(this.w*t,this.x*t,this.y*t,this.z*t)},dot:function(t,e,i,r){return o(n,t,e,i,r),this.w*n.w+this.x*n.x+this.y*n.y+this.z*n.z},inverse:function(){var t=this.w,e=this.x,o=this.y,i=this.z,n=t*t+e*e+o*o+i*i;return 0===n?r.ZERO:new r(t*(n=1/n),-e*n,-o*n,-i*n)},div:function(t,e,i,a){o(n,t,e,i,a),t=this.w,e=this.x,i=this.y,a=this.z;var s=n.w,h=n.x,m=n.y,l=n.z,u=s*s+h*h+m*m+l*l;return 0===u?r.ZERO:new r((t*s+e*h+i*m+a*l)*(u=1/u),(e*s-t*h-i*l+a*m)*u,(i*s-t*m-a*h+e*l)*u,(a*s-t*l-e*m+i*h)*u)},conjugate:function(){return new r(this.w,-this.x,-this.y,-this.z)},exp:function(){var t=this.x,e=this.y,o=this.z,i=Math.sqrt(t*t+e*e+o*o),n=Math.exp(this.w),a=n/i*Math.sin(i);return 0===i?new r(n,0,0,0):new r(n*Math.cos(i),t*a,e*a,o*a)},log:function(){var t=this.w,o=this.x,i=this.y,n=this.z;if(0===i&&0===n)return new r(e(t,o),Math.atan2(o,t),0,0);var a=Math.sqrt(o*o+i*i+n*n);return a=Math.atan2(a,t)/a,new r(.5*Math.log(o*o+i*i+n*n+t*t),o*a,i*a,n*a)},pow:function(t,i,a,s){if(o(n,t,i,a,s),0===n.y&&0===n.z){if(1===n.w&&0===n.x)return this;if(0===n.w&&0===n.x)return r.ONE;if(0===this.y&&0===this.z){if(t=this.w,i=this.x,0===t&&0===i)return r.ZERO;if(a=Math.atan2(i,t),s=e(t,i),0===n.x){if(0===i&&0<=t)return new r(Math.pow(t,n.w),0,0,0);if(0===t)switch(n.w%4){case 0:return new r(Math.pow(i,n.w),0,0,0);case 1:return new r(0,Math.pow(i,n.w),0,0);case 2:return new r(-Math.pow(i,n.w),0,0,0);case 3:return new r(0,-Math.pow(i,n.w),0,0)}}return t=Math.exp(n.w*s-n.x*a),i=n.x*s+n.w*a,new r(t*Math.cos(i),t*Math.sin(i),0,0)}}return this.log().a(n).exp()},equals:function(t,e,i,a){return o(n,t,e,i,a),t=r.EPSILON,Math.abs(n.w-this.w)<t&&Math.abs(n.x-this.x)<t&&Math.abs(n.y-this.y)<t&&Math.abs(n.z-this.z)<t},isFinite:function(){return isFinite(this.w)&&isFinite(this.x)&&isFinite(this.y)&&isFinite(this.z)},isNaN:function(){return isNaN(this.w)||isNaN(this.x)||isNaN(this.y)||isNaN(this.z)},toString:function(){var t=this.w,e=this.x,o=this.y,r=this.z;return isNaN(t)||isNaN(e)||isNaN(o)||isNaN(r)?"NaN":(t=i(t,"",""),t+=i(e,"i",t),t+=i(o,"j",t),""===(t+=i(r,"k",t))?"0":t)},real:function(){return this.w},imag:function(){return[this.x,this.y,this.z]},toVector:function(){return[this.w,this.x,this.y,this.z]},toMatrix:function(t){var e=this.w,o=this.x,i=this.y,r=this.z,n=e*e+o*o+i*i+r*r,a=0===n?0:2/n;n=a*e*o;var s=a*e*i;e=a*e*r;var h=a*o*o,m=a*o*i;o=a*o*r;var l=a*i*i;return i=a*i*r,r*=a*r,t?[[1-(l+r),m-e,o+s],[m+e,1-(h+r),i-n],[o-s,i+n,1-(h+l)]]:[1-(l+r),m-e,o+s,m+e,1-(h+r),i-n,o-s,i+n,1-(h+l)]},toMatrix4:function(t){var e=this.w,o=this.x,i=this.y,r=this.z,n=e*e+o*o+i*i+r*r,a=0===n?0:2/n;n=a*e*o;var s=a*e*i;e=a*e*r;var h=a*o*o,m=a*o*i;o=a*o*r;var l=a*i*i;return i=a*i*r,r*=a*r,t?[[1-(l+r),m-e,o+s,0],[m+e,1-(h+r),i-n,0],[o-s,i+n,1-(h+l),0],[0,0,0,1]]:[1-(l+r),m-e,o+s,0,m+e,1-(h+r),i-n,0,o-s,i+n,1-(h+l),0,0,0,0,1]},clone:function(){return new r(this)},rotateVector:function(t){var e=this.w,o=this.x,i=this.y,r=this.z,n=t[0],a=t[1],s=t[2],h=e*n+i*s-r*a,m=e*a+r*n-o*s;return[h*e-(t=-o*n-i*a-r*s)*o-m*r+(n=e*s+o*a-i*n)*i,m*e-t*i-n*o+h*r,n*e-t*r-h*i+m*o]},slerp:function(t,e,i,a){o(n,t,e,i,a);var s=this.w,h=this.x,m=this.y,l=this.z,u=n.w,d=n.x,c=n.y,g=n.z,_=s*u+h*d+m*c+l*g;if(0>_&&(s=-s,h=-h,m=-m,l=-l,_=-_),.9995<_)return function(t){return new r(s+t*(u-s),h+t*(d-h),m+t*(c-m),l+t*(g-l)).normalize()};var w=Math.acos(_),p=Math.sin(w);return function(t){var e=w*t;return t=Math.sin(e),new r((e=Math.cos(e)-_*t/p)*s+(t/=p)*u,e*h+t*d,e*m+t*c,e*l+t*g)}}},r.ZERO=new r(0,0,0,0),r.ONE=new r(1,0,0,0),r.I=new r(0,1,0,0),r.J=new r(0,0,1,0),r.K=new r(0,0,0,1),r.EPSILON=1e-16,r.fromAxisAngle=function(t,e){var o=.5*e,i=t[0],n=t[1],a=t[2],s=Math.sin(o)/Math.sqrt(i*i+n*n+a*a);return new r(Math.cos(o),i*s,n*s,a*s)},r.fromBetweenVectors=function(t,e){var o=t[0],i=t[1],n=t[2],a=e[0],s=e[1],h=e[2],m=o*a+i*s+n*h,l=i*h-n*s;return n=n*a-o*h,o=o*s-i*a,new r(m+Math.sqrt(m*m+l*l+n*n+o*o),l,n,o).normalize()},r.fromEuler=function(t,e,o,i){var n=.5*e,a=.5*o,s=.5*t;return t=Math.cos(n),o=Math.cos(a),e=Math.cos(s),n=Math.sin(n),a=Math.sin(a),s=Math.sin(s),void 0===i||"ZXY"===i?new r(t*o*e-n*a*s,n*o*e-t*a*s,t*a*e+n*o*s,t*o*s+n*a*e):"XYZ"===i?new r(t*o*e-n*a*s,n*o*e+t*a*s,t*a*e-n*o*s,t*o*s+n*a*e):"YXZ"===i?new r(t*o*e+n*a*s,n*o*e+t*a*s,t*a*e-n*o*s,t*o*s-n*a*e):"ZYX"===i?new r(t*o*e+n*a*s,n*o*e-t*a*s,t*a*e+n*o*s,t*o*s-n*a*e):"YZX"===i?new r(t*o*e-n*a*s,n*o*e+t*a*s,t*a*e+n*o*s,t*o*s-n*a*e):"XZY"===i?new r(t*o*e+n*a*s,n*o*e-t*a*s,t*a*e-n*o*s,t*o*s+n*a*e):null},N=r}();const v=N;class y extends C{constructor(t,e,o){super(t),this._type=2,this._color=e,this._opacity=o}async show(){let t=this._group.getViewer();this._nodeid=t.model.createNode(this._group._topNode,""),this._group.getManager()._sphereMesh||(this._group.getManager()._sphereMesh=await d(t));let e=new Communicator.MeshInstanceData(this._group.getManager()._sphereMesh);await t.model.createMeshInstance(e,this._nodeid);let o=new Communicator.Matrix;o.setScaleComponent(.14,.14,.14),t.model.setNodeMatrix(this._nodeid,o),t.model.setNodesFaceColor([this._nodeid],this._color),t.model.setNodesOpacity([this._nodeid],this._opacity),await super.show()}async handleMouseMove(t){let e=this._group.getViewer(),o=new Communicator.PickConfig(Communicator.SelectionMask.Line);o.restrictToOverlays=!0;const i=await e.view.pickFromPoint(t.getPosition(),o);if(i.getPosition()){let o=i.getPosition(),r=Communicator.Point3.subtract(this._startPosition,this._group._targetCenter);r.normalize();let n=Communicator.Point3.subtract(o,this._group._targetCenter);n.normalize();for(let t=0;t<this._startTargetMatrices.length;t++){let o=s(Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))),r),i=s(Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))),n),h=v.fromBetweenVectors([o.x,o.y,o.z],[i.x,i.y,i.z]),m=new Communicator.Quaternion(h.x,h.y,h.z,h.w),l=Communicator.Quaternion.toMatrix(m),u=Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(this._group._targetCenter);e.model.setNodeMatrix(this._group._targetNodes[t],a(u,this._startTargetMatrices[t],l))}this._group.updateHandle(),super.handleMouseMove(t)}}}class f extends C{constructor(t,e){super(t),this._type=1,this._color=e}async generateBaseGeometry(){let t=[];Communicator.Util.generatePointsOnCircle(t,new Communicator.Point3(0,0,0),.15,64,new Communicator.Point3(0,0,1));let e=n(t,.0045,10);this._group.getManager()._circleMesh=await this._group.getViewer().model.createMesh(e)}async show(){let t=this._group.getViewer();this._nodeid=t.model.createNode(this._group._topNode2,""),this._group.getManager()._circleMesh||await this.generateBaseGeometry();let e=new Communicator.MeshInstanceData(this._group.getManager()._circleMesh);await t.model.createMeshInstance(e,this._nodeid);let o=new Communicator.Matrix;o.setScaleComponent(1.2,1.2,1.2),t.model.setNodeMatrix(this._nodeid,o),t.model.setNodesFaceColor([this._nodeid],this._color),await super.show(),t.model.setInstanceModifier(Communicator.InstanceModifier.ScreenOriented,[this._nodeid],!0)}async handleMouseMove(t){let e=this._group.getViewer(),o=l(e,this._startPosition),i=e.view.raycastFromPoint(t.getPosition()),r=new Communicator.Point3;o.intersectsRay(i,r);let n=e.view.raycastFromPoint(this._startPosition2D),h=new Communicator.Point3;o.intersectsRay(n,h);let m=u(h,r,o.normal,this._group._targetCenter);this._group.getManager()._rotateSnapping&&(m=Math.round(m/this._group.getManager()._rotateSnapping)*this._group.getManager()._rotateSnapping);for(let t=0;t<this._startTargetMatrices.length;t++){let i=s(Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))),o.normal),r=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(i,m,r);let n=Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(this._group._targetCenter);e.model.setNodeMatrix(this._group._targetNodes[t],a(n,this._startTargetMatrices[t],r))}this._group.updateHandle(),super.handleMouseMove(t)}}class P extends M{constructor(t){super(t)}async show(t,e=null,o=null){await super.show(t,e,o),this._handles.push(new x(this,null,0,new Communicator.Color(255,0,0))),this._handles.push(new x(this,new Communicator.Point3(0,1,0),90,new Communicator.Color(0,0,255))),this._handles.push(new x(this,new Communicator.Point3(1,0,0),90,new Communicator.Color(0,200,0))),this._handles.push(new y(this,new Communicator.Color(200,200,200),.3)),this._handles.push(new f(this,new Communicator.Color(222,222,222)));for(let t=0;t<this._handles.length;t++)await this._handles[t].show()}}class z extends C{constructor(t,e,o,i){super(t),this._type=3,this._axis=e,this._rotation=o,this._color=i}async generateBaseGeometry(){let t=[];t.push(new Communicator.Point3(0,0,0)),t.push(new Communicator.Point3(0,0,.15));let e=Communicator.Util.generateConeCylinderMeshData(.0045,10,.15,.0195,.03,0);this._group.getManager()._arrowMesh=await this._group.getViewer().model.createMesh(e);let o=Communicator.Util.generateConeCylinderMeshData(0,10,.15,.0195,.03,0);this._group.getManager()._arrowMesh2=await this._group.getViewer().model.createMesh(o)}async show(){let t=this._group.getViewer(),e=new Communicator.Matrix,o=new Communicator.Matrix;this._axis&&(Communicator.Util.computeOffaxisRotation(this._axis,this._rotation,e),Communicator.Util.computeOffaxisRotation(this._axis,180,o)),this._axis||Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),-180,o),this._nodeid=t.model.createNode(this._group._topNode,""),this._group.getManager()._arrowMesh||await this.generateBaseGeometry();let i=new Communicator.MeshInstanceData(this._group.getManager()._arrowMesh);await t.model.createMeshInstance(i,this._nodeid),this._axis&&t.model.setNodeMatrix(this._nodeid,e);let r=new Communicator.MeshInstanceData(this._group.getManager()._arrowMesh2),n=await t.model.createMeshInstance(r,this._nodeid);t.model.setNodeMatrix(n,o),t.model.setNodesFaceColor([this._nodeid],this._color),await super.show()}async handleMouseMove(t){let e=this._group.getViewer(),o=new Communicator.Point3(0,0,0),i=new Communicator.Point3(0,1,0);m(this._startmatrix,o,i),Communicator.Plane.createFromPointAndNormal(o,i),e.view.raycastFromPoint(t.getPosition());let r=new Communicator.Point3(0,0,0),n=new Communicator.Point3(0,1,0);m(this._startmatrix,r,n);let a,s,h=_(r,n,this._startPosition),l=w(e,r,n,t.getPosition());if(l){for(let t=0;t<this._startTargetMatrices.length;t++)if(0==t){let o=Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(h),i=Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(l),r=Communicator.Point3.subtract(i,o),n=new Communicator.Matrix;if(this._group.getManager()._translateSnapping){let t=this._group.getManager()._translateSnapping;r.x=Math.round(r.x/t)*t,r.y=Math.round(r.y/t)*t,r.z=Math.round(r.z/t)*t}n.setTranslationComponent(r.x,r.y,r.z),a=Communicator.Matrix.multiply(this._startTargetMatrices[0],e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(new Communicator.Point3(0,0,0)),e.model.setNodeMatrix(this._group._targetNodes[t],Communicator.Matrix.multiply(this._startTargetMatrices[t],n)),s=hwv.model.getNodeNetMatrix(this._group._targetNodes[t]).transform(new Communicator.Point3(0,0,0))}else{let o=Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))),i=o.transform(a),r=o.transform(s),n=Communicator.Point3.subtract(r,i),h=new Communicator.Matrix;h.setTranslationComponent(n.x,n.y,n.z);let m=Communicator.Matrix.multiply(this._startTargetMatrices[t],h);e.model.setNodeMatrix(this._group._targetNodes[t],m)}this._group._targetCenter=e.model.getNodeNetMatrix(this._group._targetNodes[0]).transform(this._group._targetCenterLocal),this._group.updateHandle(),super.handleMouseMove(t)}}}class S extends C{constructor(t,e,o,i,r=null,n=null){super(t),this._type=4,this._axis=e,this._rotation=o,this._axis2=r,this._rotation2=n,this._color=i}async generateBaseGeometry(){let t=this._group.getViewer();this._group.getManager()._planeMesh=await async function(t,e,o,i){var r=new Communicator.MeshData;r.setFaceWinding(Communicator.FaceWinding.None);let n=[.025,-.025,0,i+e,-.025,0,.025,-.025+o,0,i+e,-.025,0,i+e,-.05-i,0,.025,-.025+o,0];return r.addFaces(n),await t.model.createMesh(r)}(t,.05,-.05,.025)}async show(){let t=this._group.getViewer(),e=new Communicator.Matrix,o=new Communicator.Matrix;this._axis&&Communicator.Util.computeOffaxisRotation(this._axis,this._rotation,e),this._axis2&&Communicator.Util.computeOffaxisRotation(this._axis2,this._rotation2,o);let i=Communicator.Matrix.multiply(e,o);this._nodeid=t.model.createNode(this._group._topNode,""),this._group.getManager()._planeMesh||await this.generateBaseGeometry();let r=new Communicator.MeshInstanceData(this._group.getManager()._planeMesh);await t.model.createMeshInstance(r,this._nodeid),this._axis&&t.model.setNodeMatrix(this._nodeid,i),t.model.setNodesFaceColor([this._nodeid],this._color),await super.show()}async handleMouseMove(t){let e=this._group.getViewer(),o=new Communicator.Point3(0,0,0),i=new Communicator.Point3(0,0,1);m(this._startmatrix,o,i);let r,n,a=Communicator.Plane.createFromPointAndNormal(o,i),s=e.view.raycastFromPoint(t.getPosition()),h=new Communicator.Point3;a.intersectsRay(s,h);for(let t=0;t<this._startTargetMatrices.length;t++)if(0==t){let o=Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(this._startPosition),i=Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(h),a=Communicator.Point3.subtract(i,o),s=new Communicator.Matrix;if(this._group.getManager()._translateSnapping){let t=this._group.getManager()._translateSnapping;a.x=Math.round(a.x/t)*t,a.y=Math.round(a.y/t)*t,a.z=Math.round(a.z/t)*t}s.setTranslationComponent(a.x,a.y,a.z),r=Communicator.Matrix.multiply(this._startTargetMatrices[0],e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(new Communicator.Point3(0,0,0)),e.model.setNodeMatrix(this._group._targetNodes[t],Communicator.Matrix.multiply(this._startTargetMatrices[t],s)),n=hwv.model.getNodeNetMatrix(this._group._targetNodes[t]).transform(new Communicator.Point3(0,0,0))}else{let o=Communicator.Matrix.inverse(e.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))),i=o.transform(r),a=o.transform(n),s=Communicator.Point3.subtract(a,i),h=new Communicator.Matrix;h.setTranslationComponent(s.x,s.y,s.z);let m=Communicator.Matrix.multiply(this._startTargetMatrices[t],h);e.model.setNodeMatrix(this._group._targetNodes[t],m)}this._group._targetCenter=e.model.getNodeNetMatrix(this._group._targetNodes[0]).transform(this._group._targetCenterLocal),this._group.updateHandle(),super.handleMouseMove(t)}}class I extends C{constructor(t,e){super(t),this._type=5,this._color=e}async show(){let t=this._group.getViewer();this._nodeid=t.model.createNode(this._group._topNode,""),this._group.getManager()._sphereMesh||(this._group.getManager()._sphereMesh=await d(t));let e=new Communicator.MeshInstanceData(this._group.getManager()._sphereMesh);await t.model.createMeshInstance(e,this._nodeid);let o=new Communicator.Matrix;o.setScaleComponent(.015,.015,.015),t.model.setNodeMatrix(this._nodeid,o),t.model.setNodesFaceColor([this._nodeid],this._color),await super.show()}async handleMouseMove(t){let e,o,i=this._group.getViewer(),r=l(i,this._startPosition),n=i.view.raycastFromPoint(t.getPosition()),a=new Communicator.Point3;r.intersectsRay(n,a);for(let t=0;t<this._startTargetMatrices.length;t++)if(0==t){let r=Communicator.Matrix.inverse(i.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(this._startPosition),n=Communicator.Matrix.inverse(i.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(a),s=Communicator.Point3.subtract(n,r),h=new Communicator.Matrix;if(this._group.getManager()._translateSnapping){let t=this._group.getManager()._translateSnapping;s.x=Math.round(s.x/t)*t,s.y=Math.round(s.y/t)*t,s.z=Math.round(s.z/t)*t}h.setTranslationComponent(s.x,s.y,s.z),e=Communicator.Matrix.multiply(this._startTargetMatrices[0],i.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))).transform(new Communicator.Point3(0,0,0)),i.model.setNodeMatrix(this._group._targetNodes[t],Communicator.Matrix.multiply(this._startTargetMatrices[t],h)),o=hwv.model.getNodeNetMatrix(this._group._targetNodes[t]).transform(new Communicator.Point3(0,0,0))}else{let r=Communicator.Matrix.inverse(i.model.getNodeNetMatrix(hwv.model.getNodeParent(this._group._targetNodes[t]))),n=r.transform(e),a=r.transform(o),s=Communicator.Point3.subtract(a,n),h=new Communicator.Matrix;h.setTranslationComponent(s.x,s.y,s.z);let m=Communicator.Matrix.multiply(this._startTargetMatrices[t],h);i.model.setNodeMatrix(this._group._targetNodes[t],m)}this._group._targetCenter=i.model.getNodeNetMatrix(this._group._targetNodes[0]).transform(this._group._targetCenterLocal),this._group.updateHandle(),super.handleMouseMove(t)}}class T extends M{constructor(t){super(t)}async show(t,e=null,o=null){await super.show(t,e,o),this._handles.push(new z(this,null,0,new Communicator.Color(255,0,0))),this._handles.push(new z(this,new Communicator.Point3(1,0,0),90,new Communicator.Color(0,0,255))),this._handles.push(new z(this,new Communicator.Point3(0,0,1),-90,new Communicator.Color(0,200,0))),this._handles.push(new S(this,new Communicator.Point3(1,0,0),-180,new Communicator.Color(255,0,0))),this._handles.push(new S(this,new Communicator.Point3(1,0,0),-180,new Communicator.Color(0,0,255),new Communicator.Point3(0,1,0),-90)),this._handles.push(new S(this,new Communicator.Point3(1,0,0),-90,new Communicator.Color(0,200,0))),this._handles.push(new I(this,new Communicator.Color(255,255,255)));for(let t=0;t<this._handles.length;t++)await this._handles[t].show()}}class F extends C{constructor(t,e,o,i){super(t),this._type=6,this._axis=e,this._rotation=o,this._color=i}async generateBaseGeometry(){let t=this._group.getViewer();this._group.getManager()._cubeMesh=await async function(t,e,o){let i;i=.0125;var r=new Communicator.MeshData;r.setFaceWinding(Communicator.FaceWinding.None);var n=[-.0125,i,i,i,i,i,-.0125,-.0125,i,i,i,i,i,-.0125,i,-.0125,-.0125,i,i,i,-.0125,-.0125,i,-.0125,-.0125,-.0125,-.0125,i,i,-.0125,-.0125,-.0125,-.0125,i,-.0125,-.0125,-.0125,i,-.0125,i,i,-.0125,i,i,i,-.0125,i,-.0125,i,i,i,-.0125,i,i,-.0125,-.0125,-.0125,i,-.0125,i,i,-.0125,-.0125,-.0125,-.0125,-.0125,-.0125,-.0125,i,i,-.0125,i,-.0125,i,-.0125,-.0125,i,i,-.0125,-.0125,-.0125,-.0125,i,i,-.0125,-.0125,i,-.0125,-.0125,-.0125,i,i,i,i,i,-.0125,i,-.0125,-.0125,i,i,i,i,-.0125,-.0125,i,-.0125,i];if(null!=e)for(var a=0;a<n.length;a+=3)n[a]+=e.x,n[a+1]+=e.y,n[a+2]+=e.z;return r.addFaces(n,[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0]),await t.model.createMesh(r)}(t,new Communicator.Point3(0,0,.15));let e=[];e.push(new Communicator.Point3(0,0,0)),e.push(new Communicator.Point3(0,0,.15));let o=n(e,.0045,10);this._group.getManager()._cubeMesh2=await this._group.getViewer().model.createMesh(o)}async show(){let t=this._group.getViewer(),e=new Communicator.Matrix;this._axis&&Communicator.Util.computeOffaxisRotation(this._axis,this._rotation,e),this._nodeid=t.model.createNode(this._group._topNode,""),this._group.getManager()._cubeMesh||await this.generateBaseGeometry();let o=new Communicator.MeshInstanceData(this._group.getManager()._cubeMesh);await t.model.createMeshInstance(o,this._nodeid),o=new Communicator.MeshInstanceData(this._group.getManager()._cubeMesh2),await t.model.createMeshInstance(o,this._nodeid),this._axis&&t.model.setNodeMatrix(this._nodeid,e),t.model.setNodesFaceColor([this._nodeid],this._color),await super.show()}async handleMouseMove(t){let e=this._group.getViewer(),o=new Communicator.Point3(0,0,0),i=new Communicator.Point3(0,0,1);m(this._startmatrix,o,i);let r,n=_(o,i,this._startPosition),a=w(e,o,i,t.getPosition()),l=Communicator.Point3.subtract(n,o).length(),u=Communicator.Plane.createFromPointAndNormal(n,i),d=Communicator.Point3.subtract(a,n);if(u.determineSide(a))r=d.length()/l/2;else if(r=-d.length()/l/2,r<=-.9)return;for(let t=0;t<this._startTargetMatrices.length;t++){let o,i;if(this._group._relative){o=s(e.model.getNodeMatrix(this._nodeid),new Communicator.Point3(0,0,1));let n=new Communicator.Matrix;n.setScaleComponent(1+o.x*r,1+o.y*r,1+o.z*r);let a=h(Communicator.Matrix.inverse(e.model.getNodeNetMatrix(this._group._targetNodes[t])).transform(this._group._targetCenter)),m=Communicator.Matrix.multiply(Communicator.Matrix.inverse(a),n),l=Communicator.Matrix.multiply(m,a);i=Communicator.Matrix.multiply(l,this._startTargetMatrices[t])}else{o=s(e.model.getNodeNetMatrix(this._nodeid),new Communicator.Point3(0,0,1));let r=h(Communicator.Matrix.inverse(e.model.getNodeNetMatrix(this._group._targetNodes[t])).transform(this._group._targetCenter)),n=Communicator.Matrix.multiply(Communicator.Matrix.inverse(r),smat),a=Communicator.Matrix.multiply(n,r);i=Communicator.Matrix.multiply(this._startTargetMatrices[t],a)}e.model.setNodeMatrix(this._group._targetNodes[t],i)}super.handleMouseMove(t)}}class b extends C{constructor(t,e){super(t),this._type=7,this._color=e}async show(){let t=this._group.getViewer();this._nodeid=t.model.createNode(this._group._topNode,""),this._group.getManager()._sphereMesh||(this._group.getManager()._sphereMesh=await d(t));let e=new Communicator.MeshInstanceData(this._group.getManager()._sphereMesh);await t.model.createMeshInstance(e,this._nodeid);let o=new Communicator.Matrix;o.setScaleComponent(.015,.015,.015),t.model.setNodeMatrix(this._nodeid,o),t.model.setNodesFaceColor([this._nodeid],this._color),await super.show()}async handleMouseMove(t){let e=this._group.getViewer(),o=$(hwv.getViewElement()).width(),i=t.getPosition().x-this._startPosition2D.x;if(i/=o/3,!(1+i<.2)){for(let t=0;t<this._startTargetMatrices.length;t++){let o=new Communicator.Matrix;o.setScaleComponent(1+i,1+i,1+i);let r=h(Communicator.Matrix.inverse(e.model.getNodeNetMatrix(this._group._targetNodes[t])).transform(this._group._targetCenter)),n=Communicator.Matrix.multiply(Communicator.Matrix.inverse(r),o),a=Communicator.Matrix.multiply(n,r),s=Communicator.Matrix.multiply(a,this._startTargetMatrices[t]);e.model.setNodeMatrix(this._group._targetNodes[t],s)}super.handleMouseMove(t)}}}class O extends M{constructor(t){super(t)}async show(t,e=null,o=null){await super.show(t,e,o),this._handles.push(new F(this,null,0,new Communicator.Color(0,0,255))),this._handles.push(new F(this,new Communicator.Point3(0,1,0),90,new Communicator.Color(0,200,0))),this._handles.push(new F(this,new Communicator.Point3(1,0,0),-90,new Communicator.Color(255,0,0))),this._handles.push(new b(this,new Communicator.Color(255,255,255)));for(let t=0;t<this._handles.length;t++)await this._handles[t].show()}}shandles=e})();